CREATE DATABASE CloverLight;
USE CloverLight;
GO
CREATE TABLE UserUC(
	UserUCId TINYINT PRIMARY KEY IDENTITY(1,1) NOT NULL,
	UserName VARCHAR (100) NOT NULL,
	Pass_word VARCHAR (100) NOT NULL,
	LastAccess DATETIME DEFAULT NULL,
	Active BIT DEFAULT 1,
	CreatedDate DATETIME DEFAULT CURRENT_TIMESTAMP,
	CreatedBy TINYINT NOT NULL,
	UpdatedDate DATETIME DEFAULT NULL,
	UpdatedBy TINYINT NOT NULL,
);
GO
CREATE TRIGGER trg_UpdatedDate_UserUC ON UserUC
	AFTER UPDATE AS UPDATE UserUC
	SET UpdatedDate = CURRENT_TIMESTAMP
	WHERE UserUCId IN (SELECT DISTINCT UserUCId FROM Inserted)
GO
INSERT INTO UserUC (UserName, Pass_word, CreatedBy, UpdatedBy)
	VALUES ('ADMIN', 'ADMIN', 1, 1);
GO
ALTER TABLE UserUC
	ADD CONSTRAINT fkCreatedBy FOREIGN KEY (CreatedBy)
	REFERENCES UserUC (UserUCId);
GO
ALTER TABLE UserUc
	ADD CONSTRAINT fkUpdatedBy FOREIGN KEY (UpdatedBy)
	REFERENCES UserUC (UserUCId);
GO
CREATE TABLE Raffle(
	RaffleId TINYINT PRIMARY KEY IDENTITY(1,1) NOT NULL,
	Description VARCHAR(300) NOT NULL,
	StartDate DATETIME NOT NULL,
	RaffleDate DATETIME NOT NULL,
	Active BIT DEFAULT 1,
	CreatedDate DATETIME DEFAULT CURRENT_TIMESTAMP,
	CreatedBy TINYINT NOT NULL,
	UpdatedDate DATETIME DEFAULT NULL,
	UpdatedBy TINYINT NOT NULL,
	CONSTRAINT fkCreatedBy_Raffle FOREIGN KEY (CreatedBy)
		REFERENCES UserUC (UserUCId),
	CONSTRAINT fkUpdatedBy_Raffle FOREIGN KEY (UpdatedBy)
		REFERENCES UserUC (UserUCId),
);
GO
CREATE TRIGGER trg_UpdatedDate_Raffle ON UserUC
	AFTER UPDATE AS UPDATE Raffle
	SET UpdatedDate = CURRENT_TIMESTAMP
	WHERE RaffleId IN (SELECT DISTINCT RaffleId FROM Inserted)
GO
CREATE TABLE Client(
	ClientId INT PRIMARY KEY IDENTITY(1,1) NOT NULL,
	Name VARCHAR(50) NOT NULL,
	LastName VARCHAR(50) NOT NULL,
	Cell VARCHAR(10) NOT NULL,
	Email VARCHAR(50) DEFAULT '',
	Observations VARCHAR(300) DEFAULT '',
	Active BIT DEFAULT 1,
	CreatedDate DATETIME DEFAULT CURRENT_TIMESTAMP,
	CreatedBy TINYINT NOT NULL,
	UpdatedDate DATETIME DEFAULT NULL,
	UpdatedBy TINYINT NOT NULL,
	CONSTRAINT uniqueCell UNIQUE (Cell),
	CONSTRAINT fkCreatedBy_Client FOREIGN KEY (CreatedBy)
		REFERENCES UserUC (UserUCId),
	CONSTRAINT fkUpdatedBy_Client FOREIGN KEY (UpdatedBy)
		REFERENCES UserUC (UserUCId)
);
GO
CREATE TRIGGER trg_UpdatedDate_Client ON Client
	AFTER UPDATE AS UPDATE Client
	SET UpdatedDate = CURRENT_TIMESTAMP
	WHERE ClientId IN (SELECT DISTINCT ClientId FROM Inserted)
GO
CREATE TABLE Prize(
	PrizeId TINYINT PRIMARY KEY IDENTITY (1,1) NOT NULL,
	RaffleId TINYINT NOT NULL,
	Product VARCHAR (100),
	Active BIT DEFAULT 1,
	CreatedDate DATETIME DEFAULT CURRENT_TIMESTAMP,
	CreatedBy TINYINT NOT NULL,
	UpdatedDate DATETIME DEFAULT NULL,
	UpdatedBy TINYINT NOT NULL,
	CONSTRAINT fkRaffleId_Prize FOREIGN KEY (RaffleId)
		REFERENCES Raffle (RaffleId),
	CONSTRAINT fkCreatedBy_Prize FOREIGN KEY (CreatedBy)
		REFERENCES UserUC (UserUCId),
	CONSTRAINT fkUpdatedBy_Prize FOREIGN KEY (UpdatedBy)
		REFERENCES UserUC (UserUCId)
);
GO
CREATE TRIGGER trg_UpdatedDate_Prize ON Prize
	AFTER UPDATE AS UPDATE Prize
	SET UpdatedDate = CURRENT_TIMESTAMP
	WHERE PrizeId IN (SELECT DISTINCT PrizeId FROM Inserted)
GO
CREATE TABLE Ticket(
	TicketId INT PRIMARY KEY IDENTITY(1,1) NOT NULL,
	RaffleId TINYINT NOT NULL,
	ClientId INT NOT NULL,
	Active BIT DEFAULT 1,
	CreatedDate DATETIME DEFAULT CURRENT_TIMESTAMP,
	CreatedBy TINYINT NOT NULL,
	UpdatedDate DATETIME DEFAULT NULL,
	UpdatedBy TINYINT NOT NULL,
	CONSTRAINT fkCreatedBy_Ticket FOREIGN KEY (CreatedBy)
		REFERENCES UserUC (UserUCId),
	CONSTRAINT fkUpdatedBy_Ticket FOREIGN KEY (UpdatedBy)
		REFERENCES UserUC (UserUCId)
);
GO
CREATE TRIGGER trg_UpdatedDate_Ticket ON Prize
	AFTER UPDATE AS UPDATE Ticket
	SET UpdatedDate = CURRENT_TIMESTAMP
	WHERE TicketId IN (SELECT DISTINCT TicketId FROM Inserted)
GO
CREATE TABLE Winner(
	WinnerId TINYINT PRIMARY KEY IDENTITY(1,1) NOT NULL,
	TicketId INT NOT NULL,
	PrizeId TINYINT NOT NULL,
	Active BIT DEFAULT 1,
	CreatedDate DATETIME DEFAULT CURRENT_TIMESTAMP,
	CreatedBy TINYINT NOT NULL,
	UpdatedDate DATETIME DEFAULT NULL,
	UpdatedBy TINYINT NOT NULL,
	CONSTRAINT fkCreatedBy_Winner FOREIGN KEY (CreatedBy)
		REFERENCES UserUC (UserUCId),
	CONSTRAINT fkUpdatedBy_Winner FOREIGN KEY (UpdatedBy)
		REFERENCES UserUC (UserUCId)
);
GO
CREATE TRIGGER trg_UpdatedDate_Winner ON Prize
	AFTER UPDATE AS UPDATE Winner
	SET UpdatedDate = CURRENT_TIMESTAMP
	WHERE WinnerId IN (SELECT DISTINCT WinnerId FROM Inserted)
GO